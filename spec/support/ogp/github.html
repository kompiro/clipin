


<!DOCTYPE html>
<html>
  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# githubog: http://ogp.me/ns/fb/githubog#">
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>OmniAuth: Overview · plataformatec/devise Wiki</title>
    <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="GitHub" />
    <link rel="fluid-icon" href="https://github.com/fluidicon.png" title="GitHub" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />




    <meta content="authenticity_token" name="csrf-param" />
<meta content="8A5H2RP6qDtJ9rQ2L8kZ0KVjLcMUdQ+Kk6SKSb5P51A=" name="csrf-token" />

    <link href="https://a248.e.akamai.net/assets.github.com/stylesheets/bundles/github-16f02a2b1a2b7d2b6edf91eaaf072e87c70f95d2.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="https://a248.e.akamai.net/assets.github.com/stylesheets/bundles/github2-d60e8ff9ae61ed2bf441f513d94ebd6d6145dd55.css" media="screen" rel="stylesheet" type="text/css" />


    <script src="https://a248.e.akamai.net/assets.github.com/javascripts/bundles/jquery-225576cef50ef2097c9f9fbcd8953c1572544611.js" type="text/javascript"></script>
    <script src="https://a248.e.akamai.net/assets.github.com/javascripts/bundles/github-353ded132c604f1bdf010516392d71052f37ffcf.js" type="text/javascript"></script>


      <script src="https://a248.e.akamai.net/assets.github.com/javascripts/bundles/wiki-6e0d12292b943f833e925fcae91f7429bc3eebdd.js" type="text/javascript"></script>
    <meta property="og:title" content="devise"/>
    <meta property="og:type" content="githubog:gitrepository"/>
    <meta property="og:url" content="https://github.com/plataformatec/devise"/>
    <meta property="og:image" content="https://a248.e.akamai.net/assets.github.com/images/gravatars/gravatar-140.png?1329275856"/>
    <meta property="og:site_name" content="GitHub"/>
    <meta property="og:description" content="devise - Flexible authentication solution for Rails with Warden."/>

    <meta name="description" content="devise - Flexible authentication solution for Rails with Warden." />
  <link href="https://github.com/plataformatec/devise/commits/master.atom" rel="alternate" title="Recent Commits to devise:master" type="application/atom+xml" />

  </head>


  <body class="logged_out   vis-public env-production " data-blob-contribs-enabled="yes">
    <div id="wrapper">





      <div id="header" class="true clearfix">
        <div class="container clearfix">
          <a class="site-logo" href="https://github.com">
            <!--[if IE]>
            <img alt="GitHub" class="github-logo" src="https://a248.e.akamai.net/assets.github.com/images/modules/header/logov7.png?1323882736" />
            <img alt="GitHub" class="github-logo-hover" src="https://a248.e.akamai.net/assets.github.com/images/modules/header/logov7-hover.png?1324325373" />
            <![endif]-->
            <img alt="GitHub" class="github-logo-4x" height="30" src="https://a248.e.akamai.net/assets.github.com/images/modules/header/logov7@4x.png?1323882736" />
            <img alt="GitHub" class="github-logo-4x-hover" height="30" src="https://a248.e.akamai.net/assets.github.com/images/modules/header/logov7@4x-hover.png?1324325373" />
          </a>

                  <!--
      make sure to use fully qualified URLs here since this nav
      is used on error pages on other domains
    -->
    <ul class="top-nav logged_out">
        <li class="pricing"><a href="https://github.com/plans">Signup and Pricing</a></li>
        <li class="explore"><a href="https://github.com/explore">Explore GitHub</a></li>
      <li class="features"><a href="https://github.com/features">Features</a></li>
        <li class="blog"><a href="https://github.com/blog">Blog</a></li>
      <li class="login"><a href="https://github.com/login?return_to=%2Fplataformatec%2Fdevise%2Fwiki%2FOmniAuth%253A-Overview">Login</a></li>
    </ul>




        </div>
      </div>



            <div class="site" itemscope itemtype="http://schema.org/WebPage">
      <div class="container">
        <div class="pagehead repohead instapaper_ignore readability-menu">
        <div class="title-actions-bar">




              <ul class="pagehead-actions">


          <li><a href="/login?return_to=%2Fplataformatec%2Fdevise" class="minibutton btn-watch watch-button entice tooltipped leftwards" rel="nofollow" title="You must be logged in to use this feature"><span><span class="icon"></span>Watch</span></a></li>
          <li><a href="/login?return_to=%2Fplataformatec%2Fdevise" class="minibutton btn-fork fork-button entice tooltipped leftwards" rel="nofollow" title="You must be logged in to use this feature"><span><span class="icon"></span>Fork</span></a></li>


      <li class="repostats">
        <ul class="repo-stats">
          <li class="watchers ">
            <a href="/plataformatec/devise/watchers" title="Watchers" class="tooltipped downwards">
              6,044
            </a>
          </li>
          <li class="forks">
            <a href="/plataformatec/devise/network" title="Forks" class="tooltipped downwards">
              733
            </a>
          </li>
        </ul>
      </li>
    </ul>

          <h1 itemscope itemtype="http://data-vocabulary.org/Breadcrumb">
            <span class="mini-icon public-repo"></span>
<a href="/plataformatec" itemprop="url">            <span itemprop="title">plataformatec</span>
            </a> /
            <strong><a href="/plataformatec/devise" class="js-current-repository">devise</a></strong>
          </h1>
        </div>



  <ul class="tabs">
    <li><a href="/plataformatec/devise" highlight="repo_sourcerepo_downloadsrepo_commitsrepo_tagsrepo_branches">Code</a></li>
    <li><a href="/plataformatec/devise/network" highlight="repo_networkrepo_fork_queue">Network</a>
    <li><a href="/plataformatec/devise/pulls" highlight="repo_pulls">Pull Requests <span class='counter'>4</span></a></li>

      <li><a href="/plataformatec/devise/issues" highlight="repo_issues">Issues <span class='counter'>8</span></a></li>

      <li><a href="/plataformatec/devise/wiki" class="selected" highlight="repo_wiki">Wiki <span class='counter'>69</span></a></li>

    <li><a href="/plataformatec/devise/graphs" highlight="repo_graphsrepo_contributors">Stats &amp; Graphs</a></li>

  </ul>




  <div class="subnav-bar">
  <ul class="subnav">
    <li><a href="/plataformatec/devise/wiki">Home</a></li>
    <li><a href="/plataformatec/devise/wiki/_pages">Pages</a></li>
    <li><a href="/plataformatec/devise/wiki/_history">Wiki History</a></li>
    <li><a href="/plataformatec/devise/wiki/_access">Git Access</a></li>
  </ul>
</div>




        </div><!-- /.repohead -->






<div id="wiki-wrapper" class="page">
<div id="head">
  <h1 class="instapaper_title">OmniAuth: Overview</h1>
  <ul class="wiki-actions readability-extra">
    <li class="gollum-minibutton"><a href="/plataformatec/devise/wiki/OmniAuth:-Overview/_history"
       class="minibutton bigger action-page-history">
       <span>Page History</span>
     </a></li>
  </ul>
</div>
<div id="wiki-content">
  <div class="wrap">
  <div id="wiki-body" class="gollum-markdown-content instapaper_body">
    <div class="markdown-body">
      <p>Since version 1.2, Devise supports integration with <a href="http://github.com/intridea/omniauth">OmniAuth</a>. This wiki page will cover the basics to have this integration working using an OAuth provider as example.</p>

<p>Since version 1.5, Devise supports OmniAuth 1.0 forward which will be the version covered by this tutorial.</p>

<h1>Facebook example</h1>

<p>The first step then is to add OmniAuth OAuth to our application, this can be done in our Gemfile:</p>

<p></p><div class="highlight">
<pre><span class="n">gem</span> <span class="s2">"omniauth-facebook"</span>
</pre>
</div>


<p>As of 1.0.0, Omniauth doesn't contain providers strategies anymore. So you should add the strategies as gems on your Gemfile. Generally, the gem name is "omniauth-#{provider}" where provider can be <code>:facebook</code>, <code>:twitter</code> or any other provider. For a full list, please check <a href="https://github.com/intridea/omniauth/wiki/List-of-Strategies">Omniauth wiki</a>. </p>

<p>Next, you need to declare the provider in your config/initializers/devise.rb and require it (if it wasn't required automatically by bundler yet):</p>

<p></p><div class="highlight">
<pre><span class="nb">require</span> <span class="s2">"omniauth-facebook"</span>
<span class="n">config</span><span class="o">.</span><span class="n">omniauth</span> <span class="ss">:facebook</span><span class="p">,</span> <span class="s2">"APP_ID"</span><span class="p">,</span> <span class="s2">"APP_SECRET"</span>
</pre>
</div>


<p>to alter the permissions requested, add the :scope option.  See <a href="https://github.com/mkdynamic/omniauth-facebook">omniauth-facebook wiki</a>,</p>
<blockquote>
<p>If for some reason Devise cannot load your strategy class, you can set it explicitly with the <code>:strategy_class</code> option:</p>

<pre><code class="ruby">config.omniauth :facebook, "APP_ID", "APP_SECRET", :strategy_class =&gt; OmniAuth::Strategies::Facebook
</code></pre>

<p>And if you run into an OpenSSL error like this: </p>

<pre><code class="ruby">OpenSSL::SSL::SSLError (SSL_connect returned=1 errno=0 state=SSLv3 read server certificate B: certificate verify failed):
</code></pre>

<p>Then you need to explicitly tell omniauth where to locate your ca_certificates file.  This can be done with the following (depending on the OS you are running on):</p>

<pre><code class="ruby">config.omniauth :facebook, "APP_ID", "APP_SECRET",
      :client_options =&gt; {:ssl =&gt; {:ca_path =&gt; '/etc/ssl/certs'}}
</code></pre>

<p>If your app is running on Heroku (and you have been pulling your hair out for hours), the config section needs to look like this:</p>

<pre><code class="ruby">config.omniauth :facebook, "APP_ID", "APP_SECRET",
      {:scope =&gt; 'email, offline_access', :client_options =&gt; {:ssl =&gt; {:ca_file =&gt; '/usr/lib/ssl/certs/ca-certificates.crt'}}}
</code></pre>

<p>On Engine Yard Cloud servers, the CA file is located at <code>/etc/ssl/certs/ca-certificates.crt</code>.</p>

<p>A deeper discussion of this error can be found here: <a href="https://github.com/intridea/omniauth/issues/260">https://github.com/intridea/omniauth/issues/260</a></p>
</blockquote>
<p>After configuring your strategy, you need to make your model (e.g. app/models/user.rb) omniauthable:</p>

<p></p><div class="highlight">
<pre><span class="n">devise</span> <span class="ss">:omniauthable</span>
</pre>
</div>


<p>Currently, Devise only allows you to make one model omniauthable. After making a model named <code>User</code> omniauthable and if "devise_for :users" was already added to your config/routes.rb, Devise will create the following url methods:</p>

<ul>
<li>user_omniauth_authorize_path(provider)</li>
<li>user_omniauth_callback_path(provider)</li>
</ul><p>Note that devise does not create *_url method. While you will never use the callback helper above directly, you only need to add the first one to your layouts in order to provide facebook authorization:</p>

<p></p><div class="highlight">
<pre><span class="o">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Sign in with Facebook"</span><span class="p">,</span> <span class="n">user_omniauth_authorize_path</span><span class="p">(</span><span class="ss">:facebook</span><span class="p">)</span> <span class="o">%&gt;</span>
</pre>
</div>

<blockquote>
<h3>If you have a "catch all" route (route globbing):</h3>

<p>Omniauth calls through to the app for dynamic configuration settings, so you will need to define a route for <code>/auth/:provider</code> that results in a 404 so Omniauth knows how to proceed if you have a "catch all" route. The reasoning behind this can be found <a href="http://stackoverflow.com/questions/5531263/omniauth-doesnt-work-with-route-globbing-in-rails3">here</a>. Inside your <code>devise_scope :user</code> routes block, add this:</p>

<pre><code class="ruby">devise_scope :user do
  get '/users/auth/:provider' =&gt; 'users/omniauth_callbacks#passthru'
end
</code></pre>

<p>And then add this method inside of the Omniauth Callbacks Controller (details follow):</p>

<pre><code class="ruby">def passthru
  render :file =&gt; "#{Rails.root}/public/404.html", :status =&gt; 404, :layout =&gt; false
  # Or alternatively,
  # raise ActionController::RoutingError.new('Not Found')
end
</code></pre>
</blockquote>
<p>By clicking on the above link, the user will be redirected to Facebook. (If this link doesn't exist, try restarting the server.) After inserting their credentials, they will be redirected back to your application's callback method. To implement a callback, the first step is to go back to our config/routes.rb file and tell Devise in which controller we will implement Omniauth callbacks:</p>

<p></p><div class="highlight">
<pre><span class="n">devise_for</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:controllers</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:omniauth_callbacks</span> <span class="o">=&gt;</span> <span class="s2">"users/omniauth_callbacks"</span> <span class="p">}</span>
</pre>
</div>


<p>Now we just add the file "app/controllers/users/omniauth_callbacks_controller.rb":</p>

<p></p><div class="highlight">
<pre><span class="k">class</span> <span class="nc">Users</span><span class="o">::</span><span class="no">OmniauthCallbacksController</span> <span class="o">&lt;</span> <span class="no">Devise</span><span class="o">::</span><span class="no">OmniauthCallbacksController</span>
<span class="k">end</span>
</pre>
</div>


<p>The callback should be implemented as an action with the same name as the provider. Here is an example action for our facebook provider that we could add to our controller:</p>

<p></p><div class="highlight">
<pre><span class="k">class</span> <span class="nc">Users</span><span class="o">::</span><span class="no">OmniauthCallbacksController</span> <span class="o">&lt;</span> <span class="no">Devise</span><span class="o">::</span><span class="no">OmniauthCallbacksController</span>
  <span class="k">def</span> <span class="nf">facebook</span>
    <span class="c1"># You need to implement the method below in your model</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_for_facebook_oauth</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s2">"omniauth.auth"</span><span class="o">]</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span>

    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">persisted?</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span> <span class="s2">"devise.omniauth_callbacks.success"</span><span class="p">,</span> <span class="ss">:kind</span> <span class="o">=&gt;</span> <span class="s2">"Facebook"</span>
      <span class="n">sign_in_and_redirect</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:event</span> <span class="o">=&gt;</span> <span class="ss">:authentication</span>
    <span class="k">else</span>
      <span class="n">session</span><span class="o">[</span><span class="s2">"devise.facebook_data"</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s2">"omniauth.auth"</span><span class="o">]</span>
      <span class="n">redirect_to</span> <span class="n">new_user_registration_url</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>This action has a few aspects worth describing:</p>

<ol>
<li><p>All information retrieved from Facebook by OmniAuth is available as a hash at request.env["omniauth.auth"]. Check omniauth docs for more information.</p></li>
<li><p>In case a valid user is given from our model, we should sign it in. Notice we set a flash message using one of Devise's default messages, but that is up to you. Next, we sign the user in and redirect it. We pass the :event =&gt; :authentication to the sign_in_and_redirect method to force all authentication callbacks to be called.</p></li>
<li><p>In case the user is not persisted, we store the OmniAuth data in the session. Notice we store this data using "devise." as key namespace. This is useful because Devise removes all the data starting with "devise." from the session whenever a user signs in, so we get automatic session clean up. At the end, we redirect the user back to our registration form.</p></li>
</ol><p>After the controller is defined, we need to implement the <code>find_for_facebook_oauth</code> method in our model:</p>

<p></p><div class="highlight">
<pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_for_facebook_oauth</span><span class="p">(</span><span class="n">access_token</span><span class="p">,</span> <span class="n">signed_in_resource</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">access_token</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">raw_info</span>
  <span class="k">if</span> <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">data</span><span class="o">.</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
    <span class="n">user</span>
  <span class="k">else</span> <span class="c1"># Create a user with a stub password. </span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">data</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="no">Devise</span><span class="o">.</span><span class="n">friendly_token</span><span class="o">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>The method above simply tries to find an existing user by e-mail or create one with a random password otherwise. Note that this is simply an example. Your application must take precautions if using <code>User.find_by_email</code> to link an existing User with a Facebook account.</p>

<p>Notice that Devise RegistrationsController by default calls "User.new_with_session" before building a resource. This means that, if we need to copy data from session whenever a user is initialized before sign up, we just need to implement <code>new_with_session</code> in our model. Here is an example that copies the facebook email if available:</p>

<p></p><div class="highlight">
<pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">new_with_session</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
    <span class="k">super</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">data</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="s2">"devise.facebook_data"</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="n">session</span><span class="o">[</span><span class="s2">"devise.facebook_data"</span><span class="o">][</span><span class="s2">"extra"</span><span class="o">][</span><span class="s2">"raw_info"</span><span class="o">]</span>
        <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s2">"email"</span><span class="o">]</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>Finally, if you want to allow your users to cancel sign up with Facebook, you can redirect them to "cancel_user_registration_path". This will remove all session data starting with "devise." and the <code>new_with_session</code> hook above will no longer be called.</p>

<p>And that is all you need! After you get your integration working, it's time to write some tests:</p>

<p><a href="https://github.com/intridea/omniauth/wiki/Integration-Testing"></a><a href="https://github.com/intridea/omniauth/wiki/Integration-Testing">https://github.com/intridea/omniauth/wiki/Integration-Testing</a></p>

<h1>Using OmniAuth without other authentications</h1>

<p>If you are using ONLY omniauth authentication, you need to define a route named new_user_session (if not defined, root will be used). Below is an example of such routes (you don't need to include it if you are also using database or other authentication with omniauth):</p>

<p></p><div class="highlight">
<pre><span class="n">devise_for</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:controllers</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:omniauth_callbacks</span> <span class="o">=&gt;</span> <span class="s2">"users/omniauth_callbacks"</span> <span class="p">}</span>

<span class="n">devise_scope</span> <span class="ss">:user</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s1">'sign_in'</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s1">'users/sessions#new'</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:new_user_session</span>
  <span class="n">get</span> <span class="s1">'sign_out'</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s1">'users/sessions#destroy'</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:destroy_user_session</span>
<span class="k">end</span>
</pre>
</div>


<p>In the example above, the sessions controller doesn't need to do anything special. For example, showing a link to the provider authentication will suffice.</p>

<h1>OpenID and Google examples</h1>

<p>Add OmniAuth OpenID to your Gemfile:</p>

<p></p><div class="highlight">
<pre><span class="n">gem</span> <span class="s1">'omniauth-openid'</span>
</pre>
</div>


<p>In order to use following features, you have to require openid store in Devise initializer. For example:</p>

<p></p><div class="highlight">
<pre><span class="nb">require</span> <span class="s1">'openid/store/filesystem'</span>
</pre>
</div>


<h2>OpenID</h2>

<p>Add following code to Devise initializer</p>

<p></p><div class="highlight">
<pre><span class="n">config</span><span class="o">.</span><span class="n">omniauth</span> <span class="ss">:open_id</span><span class="p">,</span> <span class="ss">:store</span> <span class="o">=&gt;</span> <span class="no">OpenID</span><span class="o">::</span><span class="no">Store</span><span class="o">::</span><span class="no">Filesystem</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'/tmp'</span><span class="p">),</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="s1">'omniauth-openid'</span>
</pre>
</div>


<p>Use this in your view:</p>

<p></p><div class="highlight">
<pre><span class="n">link_to</span> <span class="s2">"sign in with yahoo"</span><span class="p">,</span> <span class="n">user_omniauth_authorize_path</span><span class="p">(</span><span class="ss">:open_id</span><span class="p">,</span> <span class="ss">:openid_url</span> <span class="o">=&gt;</span> <span class="s2">"http://yahoo.com"</span><span class="p">)</span>
</pre>
</div>


<h2>Google</h2>

<p>Add following code to Devise initializer</p>

<p></p><div class="highlight">
<pre><span class="n">config</span><span class="o">.</span><span class="n">omniauth</span> <span class="ss">:open_id</span><span class="p">,</span> <span class="ss">:store</span> <span class="o">=&gt;</span> <span class="no">OpenID</span><span class="o">::</span><span class="no">Store</span><span class="o">::</span><span class="no">Filesystem</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'/tmp'</span><span class="p">),</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'google'</span><span class="p">,</span> <span class="ss">:identifier</span> <span class="o">=&gt;</span> <span class="s1">'https://www.google.com/accounts/o8/id'</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="s1">'omniauth-openid'</span>
</pre>
</div>


<p>Add the following definition in models/user.rb</p>

<p></p><div class="highlight">
<pre><span class="n">devise</span> <span class="ss">:omniauthable</span> <span class="c1">#followed by anything else you need</span>

<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_for_open_id</span><span class="p">(</span><span class="n">access_token</span><span class="p">,</span> <span class="n">signed_in_resource</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">access_token</span><span class="o">.</span><span class="n">info</span>
  <span class="k">if</span> <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">data</span><span class="o">[</span><span class="s2">"email"</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
    <span class="n">user</span>
  <span class="k">else</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">data</span><span class="o">[</span><span class="s2">"email"</span><span class="o">]</span><span class="p">,</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="no">Devise</span><span class="o">.</span><span class="n">friendly_token</span><span class="o">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>Next create a file in app/controllers/users/omniauth_callbacks_controller.rb and give it the following content:</p>

<p></p><div class="highlight">
<pre><span class="k">class</span> <span class="nc">Users</span><span class="o">::</span><span class="no">OmniauthCallbacksController</span> <span class="o">&lt;</span> <span class="no">Devise</span><span class="o">::</span><span class="no">OmniauthCallbacksController</span>
  <span class="k">def</span> <span class="nf">google</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_for_open_id</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s2">"omniauth.auth"</span><span class="o">]</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span>

    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">persisted?</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span> <span class="s2">"devise.omniauth_callbacks.success"</span><span class="p">,</span> <span class="ss">:kind</span> <span class="o">=&gt;</span> <span class="s2">"Google"</span>
      <span class="n">sign_in_and_redirect</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:event</span> <span class="o">=&gt;</span> <span class="ss">:authentication</span>
    <span class="k">else</span>
      <span class="n">session</span><span class="o">[</span><span class="s2">"devise.google_data"</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s2">"omniauth.auth"</span><span class="o">]</span>
      <span class="n">redirect_to</span> <span class="n">new_user_registration_url</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>You'll also need to change the routing in routes.rb to:</p>

<p></p><div class="highlight">
<pre><span class="n">devise_for</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:controllers</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:omniauth_callbacks</span> <span class="o">=&gt;</span> <span class="s2">"users/omniauth_callbacks"</span> <span class="p">}</span>
</pre>
</div>

Finally use this in your view:

<p></p><div class="highlight">
<pre><span class="n">link_to</span> <span class="s2">"sign in with google"</span><span class="p">,</span> <span class="n">user_omniauth_authorize_path</span><span class="p">(</span><span class="ss">:google</span><span class="p">)</span>
</pre>
</div>


<p>This code allows all users of Google Mail and Google Apps (i.e. with a domain name other than gmail.com, like <a href="mailto:JonDoe@domain-with-google-apps.com">JonDoe@domain-with-google-apps.com</a>) to sign in. It is not restricted to a particular domain like a Google Apps solution would be. </p>

<h2>Google Apps</h2>

<p>NOTE: As of today, 24th November 2011, it seems there isn't a gem that supports Google Apps on OmniAuth 1.0. When it is available, this tutorial should be updated to include the required gems in Gemfile.</p>

<p>Devise initializer:</p>

<p></p><div class="highlight">
<pre><span class="n">config</span><span class="o">.</span><span class="n">omniauth</span> <span class="ss">:google_apps</span><span class="p">,</span> <span class="no">OpenID</span><span class="o">::</span><span class="no">Store</span><span class="o">::</span><span class="no">Filesystem</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'/tmp'</span><span class="p">),</span> <span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s1">'gmail.com'</span>
</pre>
</div>


<p>User Model:</p>

<p></p><div class="highlight">
<pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_for_googleapps_oauth</span><span class="p">(</span><span class="n">access_token</span><span class="p">,</span> <span class="n">signed_in_resource</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">access_token</span><span class="o">[</span><span class="s1">'user_info'</span><span class="o">]</span>
  <span class="k">if</span> <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">data</span><span class="o">[</span><span class="s1">'email'</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
    <span class="n">user</span>
  <span class="k">else</span> <span class="c1">#create a user with stub pwd</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">data</span><span class="o">[</span><span class="s1">'email'</span><span class="o">]</span><span class="p">,</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="no">Devise</span><span class="o">.</span><span class="n">friendly_token</span><span class="o">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">new_with_session</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
  <span class="k">super</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">data</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="s1">'devise.googleapps_data'</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="n">session</span><span class="o">[</span><span class="s1">'devise.googleapps_data'</span><span class="o">][</span><span class="s1">'user_info'</span><span class="o">]</span>
      <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s1">'email'</span><span class="o">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>View:</p>

<p></p><div class="highlight">
<pre><span class="n">link_to</span> <span class="s1">'GMail'</span><span class="p">,</span> <span class="n">user_omniauth_authorize_path</span><span class="p">(</span><span class="ss">:google_apps</span><span class="p">)</span>
</pre>
</div>

    </div>
  </div>
  </div>

</div>
<div id="gollum-footer">
  <p id="last-edit">
    Last edited by reggieb, <time class="js-relative-date" datetime="2012-03-22T03:24:19-07:00" title="2012-03-22 03:24:19">March 22, 2012</time>
  </p>
</div>
</div>


      </div>
      <div class="context-overlay"></div>
    </div>

      <div id="footer-push"></div><!-- hack for sticky footer -->
    </div><!-- end of wrapper - hack for sticky footer -->

      <!-- footer -->
      <div id="footer" >

  <div class="upper_footer">
     <div class="container clearfix">

       <!--[if IE]><h4 id="blacktocat_ie">GitHub Links</h4><![endif]-->
       <![if !IE]><h4 id="blacktocat">GitHub Links</h4><![endif]>

       <ul class="footer_nav">
         <h4>GitHub</h4>
         <li><a href="https://github.com/about">About</a></li>
         <li><a href="https://github.com/blog">Blog</a></li>
         <li><a href="https://github.com/features">Features</a></li>
         <li><a href="https://github.com/contact">Contact &amp; Support</a></li>
         <li><a href="https://github.com/training">Training</a></li>
         <li><a href="http://enterprise.github.com/">GitHub Enterprise</a></li>
         <li><a href="http://status.github.com/">Site Status</a></li>
       </ul>

       <ul class="footer_nav">
         <h4>Tools</h4>
         <li><a href="http://get.gaug.es/">Gauges: Analyze web traffic</a></li>
         <li><a href="http://speakerdeck.com">Speaker Deck: Presentations</a></li>
         <li><a href="https://gist.github.com">Gist: Code snippets</a></li>
         <li><a href="http://mac.github.com/">GitHub for Mac</a></li>
         <li><a href="http://mobile.github.com/">Issues for iPhone</a></li>
         <li><a href="http://jobs.github.com/">Job Board</a></li>
       </ul>

       <ul class="footer_nav">
         <h4>Extras</h4>
         <li><a href="http://shop.github.com/">GitHub Shop</a></li>
         <li><a href="http://octodex.github.com/">The Octodex</a></li>
       </ul>

       <ul class="footer_nav">
         <h4>Documentation</h4>
         <li><a href="http://help.github.com/">GitHub Help</a></li>
         <li><a href="http://developer.github.com/">Developer API</a></li>
         <li><a href="http://github.github.com/github-flavored-markdown/">GitHub Flavored Markdown</a></li>
         <li><a href="http://pages.github.com/">GitHub Pages</a></li>
       </ul>

     </div><!-- /.site -->
  </div><!-- /.upper_footer -->

<div class="lower_footer">
  <div class="container clearfix">
    <!--[if IE]><div id="legal_ie"><![endif]-->
    <![if !IE]><div id="legal"><![endif]>
      <ul>
          <li><a href="https://github.com/site/terms">Terms of Service</a></li>
          <li><a href="https://github.com/site/privacy">Privacy</a></li>
          <li><a href="https://github.com/security">Security</a></li>
      </ul>

      <p>&copy; 2012 <span title="0.08958s from fe8.rs.github.com">GitHub</span> Inc. All rights reserved.</p>
    </div><!-- /#legal or /#legal_ie-->

      <div class="sponsor">
        <a href="http://www.rackspace.com" class="logo">
          <img alt="Dedicated Server" height="36" src="https://a248.e.akamai.net/assets.github.com/images/modules/footer/rackspaces_logo.png?1329521041" width="38" />
        </a>
        Powered by the <a href="http://www.rackspace.com ">Dedicated
        Servers</a> and<br/> <a href="http://www.rackspacecloud.com">Cloud
        Computing</a> of Rackspace Hosting<span>&reg;</span>
      </div>
  </div><!-- /.site -->
</div><!-- /.lower_footer -->

      </div><!-- /#footer -->



<div id="keyboard_shortcuts_pane" class="instapaper_ignore readability-extra" style="display:none">
  <h2>Keyboard Shortcuts <small><a href="#" class="js-see-all-keyboard-shortcuts">(see all)</a></small></h2>

  <div class="columns threecols">
    <div class="column first">
      <h3>Site wide shortcuts</h3>
      <dl class="keyboard-mappings">
        <dt>s</dt>
        <dd>Focus site search</dd>
      </dl>
      <dl class="keyboard-mappings">
        <dt>?</dt>
        <dd>Bring up this help dialog</dd>
      </dl>
    </div><!-- /.column.first -->

    <div class="column middle" style='display:none'>
      <h3>Commit list</h3>
      <dl class="keyboard-mappings">
        <dt>j</dt>
        <dd>Move selection down</dd>
      </dl>
      <dl class="keyboard-mappings">
        <dt>k</dt>
        <dd>Move selection up</dd>
      </dl>
      <dl class="keyboard-mappings">
        <dt>c <em>or</em> o <em>or</em> enter</dt>
        <dd>Open commit</dd>
      </dl>
      <dl class="keyboard-mappings">
        <dt>y</dt>
        <dd>Expand URL to its canonical form</dd>
      </dl>
    </div><!-- /.column.first -->

    <div class="column last" style='display:none'>
      <h3>Pull request list</h3>
      <dl class="keyboard-mappings">
        <dt>j</dt>
        <dd>Move selection down</dd>
      </dl>
      <dl class="keyboard-mappings">
        <dt>k</dt>
        <dd>Move selection up</dd>
      </dl>
      <dl class="keyboard-mappings">
        <dt>o <em>or</em> enter</dt>
        <dd>Open issue</dd>
      </dl>
    </div><!-- /.columns.last -->

  </div><!-- /.columns.equacols -->

  <div style='display:none'>
    <div class="rule"></div>

    <h3>Issues</h3>

    <div class="columns threecols">
      <div class="column first">
        <dl class="keyboard-mappings">
          <dt>j</dt>
          <dd>Move selection down</dd>
        </dl>
        <dl class="keyboard-mappings">
          <dt>k</dt>
          <dd>Move selection up</dd>
        </dl>
        <dl class="keyboard-mappings">
          <dt>x</dt>
          <dd>Toggle selection</dd>
        </dl>
        <dl class="keyboard-mappings">
          <dt>o <em>or</em> enter</dt>
          <dd>Open issue</dd>
        </dl>
      </div><!-- /.column.first -->
      <div class="column middle">
        <dl class="keyboard-mappings">
          <dt>I</dt>
          <dd>Mark selection as read</dd>
        </dl>
        <dl class="keyboard-mappings">
          <dt>U</dt>
          <dd>Mark selection as unread</dd>
        </dl>
        <dl class="keyboard-mappings">
          <dt>y</dt>
          <dd>Remove selection from view</dd>
        </dl>
      </div><!-- /.column.middle -->
      <div class="column last">
        <dl class="keyboard-mappings">
          <dt>c</dt>
          <dd>Create issue</dd>
        </dl>
        <dl class="keyboard-mappings">
          <dt>l</dt>
          <dd>Create label</dd>
        </dl>
        <dl class="keyboard-mappings">
          <dt>i</dt>
          <dd>Back to inbox</dd>
        </dl>
        <dl class="keyboard-mappings">
          <dt>u</dt>
          <dd>Back to issues</dd>
        </dl>
        <dl class="keyboard-mappings">
          <dt>/</dt>
          <dd>Focus issues search</dd>
        </dl>
      </div>
    </div>
  </div>

  <div style='display:none'>
    <div class="rule"></div>

    <h3>Issues Dashboard</h3>

    <div class="columns threecols">
      <div class="column first">
        <dl class="keyboard-mappings">
          <dt>j</dt>
          <dd>Move selection down</dd>
        </dl>
        <dl class="keyboard-mappings">
          <dt>k</dt>
          <dd>Move selection up</dd>
        </dl>
        <dl class="keyboard-mappings">
          <dt>o <em>or</em> enter</dt>
          <dd>Open issue</dd>
        </dl>
      </div><!-- /.column.first -->
    </div>
  </div>

  <div style='display:none'>
    <div class="rule"></div>

    <h3>Network Graph</h3>
    <div class="columns equacols">
      <div class="column first">
        <dl class="keyboard-mappings">
          <dt><span class="badmono">←</span> <em>or</em> h</dt>
          <dd>Scroll left</dd>
        </dl>
        <dl class="keyboard-mappings">
          <dt><span class="badmono">→</span> <em>or</em> l</dt>
          <dd>Scroll right</dd>
        </dl>
        <dl class="keyboard-mappings">
          <dt><span class="badmono">↑</span> <em>or</em> k</dt>
          <dd>Scroll up</dd>
        </dl>
        <dl class="keyboard-mappings">
          <dt><span class="badmono">↓</span> <em>or</em> j</dt>
          <dd>Scroll down</dd>
        </dl>
        <dl class="keyboard-mappings">
          <dt>t</dt>
          <dd>Toggle visibility of head labels</dd>
        </dl>
      </div><!-- /.column.first -->
      <div class="column last">
        <dl class="keyboard-mappings">
          <dt>shift <span class="badmono">←</span> <em>or</em> shift h</dt>
          <dd>Scroll all the way left</dd>
        </dl>
        <dl class="keyboard-mappings">
          <dt>shift <span class="badmono">→</span> <em>or</em> shift l</dt>
          <dd>Scroll all the way right</dd>
        </dl>
        <dl class="keyboard-mappings">
          <dt>shift <span class="badmono">↑</span> <em>or</em> shift k</dt>
          <dd>Scroll all the way up</dd>
        </dl>
        <dl class="keyboard-mappings">
          <dt>shift <span class="badmono">↓</span> <em>or</em> shift j</dt>
          <dd>Scroll all the way down</dd>
        </dl>
      </div><!-- /.column.last -->
    </div>
  </div>

  <div style='display:none'>
    <div class="rule"></div>
    <div class="columns threecols">
      <div class="column first" style='display:none'>
        <h3>Source Code Browsing</h3>
        <dl class="keyboard-mappings">
          <dt>t</dt>
          <dd>Activates the file finder</dd>
        </dl>
        <dl class="keyboard-mappings">
          <dt>l</dt>
          <dd>Jump to line</dd>
        </dl>
        <dl class="keyboard-mappings">
          <dt>w</dt>
          <dd>Switch branch/tag</dd>
        </dl>
        <dl class="keyboard-mappings">
          <dt>y</dt>
          <dd>Expand URL to its canonical form</dd>
        </dl>
      </div>
    </div>
  </div>
</div>

    <div id="markdown-help" class="instapaper_ignore readability-extra">
  <h2>Markdown Cheat Sheet</h2>

  <div class="cheatsheet-content">

  <div class="mod">
    <div class="col">
      <h3>Format Text</h3>
      <p>Headers</p>
      <pre>
# This is an &lt;h1&gt; tag
## This is an &lt;h2&gt; tag
###### This is an &lt;h6&gt; tag</pre>
     <p>Text styles</p>
     <pre>
*This text will be italic*
_This will also be italic_
**This text will be bold**
__This will also be bold__

*You **can** combine them*
</pre>
    </div>
    <div class="col">
      <h3>Lists</h3>
      <p>Unordered</p>
      <pre>
* Item 1
* Item 2
  * Item 2a
  * Item 2b</pre>
     <p>Ordered</p>
     <pre>
1. Item 1
2. Item 2
3. Item 3
   * Item 3a
   * Item 3b</pre>
    </div>
    <div class="col">
      <h3>Miscellaneous</h3>
      <p>Images</p>
      <pre>
![GitHub Logo](/images/logo.png)
Format: ![Alt Text](url)
</pre>
     <p>Links</p>
     <pre>
http://github.com - automatic!
[GitHub](http://github.com)</pre>
<p>Blockquotes</p>
     <pre>
As Kanye West said:

> We're living the future so
> the present is our past.
</pre>
    </div>
  </div>
  <div class="rule"></div>

  <h3>Code Examples in Markdown</h3>
  <div class="col">
      <p>Syntax highlighting with <a href="http://github.github.com/github-flavored-markdown/" title="GitHub Flavored Markdown" target="_blank">GFM</a></p>
      <pre>
```javascript
function fancyAlert(arg) {
  if(arg) {
    $.facebox({div:'#foo'})
  }
}
```</pre>
    </div>
    <div class="col">
      <p>Or, indent your code 4 spaces</p>
      <pre>
Here is a Python code example
without syntax highlighting:

    def foo:
      if not bar:
        return true</pre>
    </div>
    <div class="col">
      <p>Inline code for comments</p>
      <pre>
I think you should use an
`&lt;addr&gt;` element here instead.</pre>
    </div>
  </div>

  </div>
</div>


    <div class="ajax-error-message">
      <p><span class="icon"></span> Something went wrong with that request. Please try again. <a href="javascript:;" class="ajax-error-dismiss">Dismiss</a></p>
    </div>

    <div id="logo-popup">
      <h2>Looking for the GitHub logo?</h2>
      <ul>
        <li>
          <h4>GitHub Logo</h4>
          <a href="http://github-media-downloads.s3.amazonaws.com/GitHub_Logos.zip"><img alt="Github_logo" src="https://a248.e.akamai.net/assets.github.com/images/modules/about_page/github_logo.png?1310104853" /></a>
          <a href="http://github-media-downloads.s3.amazonaws.com/GitHub_Logos.zip" class="minibutton btn-download download"><span><span class="icon"></span>Download</span></a>
        </li>
        <li>
          <h4>The Octocat</h4>
          <a href="http://github-media-downloads.s3.amazonaws.com/Octocats.zip"><img alt="Octocat" src="https://a248.e.akamai.net/assets.github.com/images/modules/about_page/octocat.png?1310104853" /></a>
          <a href="http://github-media-downloads.s3.amazonaws.com/Octocats.zip" class="minibutton btn-download download"><span><span class="icon"></span>Download</span></a>
        </li>
      </ul>
    </div>




    <span id='server_response_time' data-time='0.09180' data-host='fe8'></span>
  </body>
</html>

